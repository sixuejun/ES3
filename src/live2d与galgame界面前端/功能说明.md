# Galgame 界面功能说明

## 概述

这是一个完整的 Galgame 风格对话界面，用于在酒馆（SillyTavern）中提供沉浸式的视觉小说体验。界面支持 Live2D 模型渲染、多种对话框样式自定义、消息格式解析、角色状态栏、以及与酒馆的深度集成。

界面采用 16:9 横屏显示，支持响应式缩放，可在不同设备和屏幕方向下自动适配。

---

## 项目结构

```
live2d与galgame界面前端/
├── index.html          # 入口 HTML
├── index.ts            # 入口脚本，挂载 Vue 应用
├── app.vue             # 根组件
├── Live2DRenderer.ts   # Live2D 渲染器封装
├── components/
│   ├── GalgamePlayer.vue        # 主播放器组件
│   ├── DialogBox.vue            # 对话框组件
│   ├── ChoiceBox.vue            # 选项框组件
│   ├── CharacterSprite.vue      # 角色立绘组件
│   ├── CharacterStatusPanel.vue # 角色状态栏组件
│   ├── SettingsPanel.vue        # 设置面板组件
│   └── ColorSlider.vue          # 颜色选择器组件
├── lib/
│   ├── messageParser.ts  # 消息解析器
│   └── utils.ts          # 工具函数
├── types/
│   └── galgame.ts        # 类型定义和样式预设
└── styles/
    └── globals.css       # 全局样式（Tailwind CSS 主题）
```

---

## 主要功能

### 1. 对话系统

#### 对话框功能

- **打字机效果**：文字逐字显示（50ms/字符）
- **角色名称显示**：支持多种名称标签样式
- **旁白系统**：无角色名的消息以斜体居中显示
- **through 消息**：特殊浅灰色斜体文字（内心独白）
- **前进/后退**：箭头按钮或点击切换对话
- **呼吸指示器**：多种动态指示器样式
- **流式加载**：AI 生成时显示呼吸指示器，对已完成文本应用打字机效果

#### 对话框样式自定义

- **文本框形状**：圆角、胶囊、直角、柔和、画框
- **边框粗细**：无、细、中、粗、加粗
- **背景图案**：无、方格、圆点、菱形、条纹、柔光渐变
- **角色名样式**：标签、胶囊、方形、下划线、悬浮
- **箭头按钮**：圆形、方形、胶囊、极简、内嵌圆、内嵌方
- **呼吸指示器**：呼吸点、菱形、脉冲、箭头、无
- **颜色自定义**：所有元素颜色可通过颜色选择器调整
- **样式持久化**：样式设置自动保存到 localStorage

---

### 2. 消息格式解析

界面支持解析特定格式的消息块：

```
[[character||角色全名||场景||动作||表情||台词]]
[[character||角色全名||CG场景||台词]]
[[narration||场景||旁白内容]]
[[blacktext||黑屏文字]]
[[user||场景||用户消息]]
[[choice||选项1||选项2||选项3]]
```

#### 特殊格式

- **through 消息**：在台词中包含 `*through*` 会显示为浅灰色斜体
- **CG 模式**：当没有动作和表情时自动进入 CG 模式，隐藏立绘显示 CG 图片
- **状态栏解析**：支持解析 `<StatusBlock>` 格式的角色状态

---

### 3. 选项系统

#### 选项框功能

- **选项显示**：支持动态数量的选项
- **样式统一**：与对话框样式保持一致
- **自由输入**：支持用户自定义输入
- **保存功能**：📇 按钮可将输入保存到正文但不发送

#### 选项交互

- **点击选择**：点击选项按钮选择
- **输入确认**：Enter 键确认输入
- **自动发送**：选择后自动发送消息并触发 AI 回复
- **智能裁剪**：
  - **演出中**：发送前自动删除后续剧情文本（避免污染上下文）
  - **演出完成后**：直接发送，不删除后续对话（因为已经是最后一条）

#### 选项文本裁剪

- **自动识别**：选择选项后，自动识别并裁剪当前消息中关于选项的文本
- **只保留被选选项**：只留下最终被选择的选项文本，删除其他选项文本
- **不刷新界面**：操作类似用户编辑消息，同样不刷新界面

#### 点击区域导航

- **黑屏转场**：点击左半屏返回上一条，点击右半屏继续下一条
- **选择框界面**：点击左半屏返回上一条，点击右半屏继续下一条

---

### 4. 输入系统

#### 输入框功能

- **打开方式**：点击左上角角色按钮 → 输入按钮
- **回车发送**：在输入框中按 Enter 键直接发送消息并触发 AI 回复
- **保存功能**：📇 按钮可将输入保存到正文但不发送
- **智能裁剪**：
  - **演出中**：发送前自动删除后续剧情文本（避免污染上下文）
  - **演出完成后**：直接发送，不删除后续对话

#### 输入交互

- **自动聚焦**：打开输入框时自动聚焦到输入框
- **ESC 关闭**：按 ESC 键关闭输入框
- **点击外部关闭**：点击输入框外部区域关闭

---

### 5. 角色立绘系统

#### 立绘类型

- **Live2D 模型**：支持完整的 Live2D 模型渲染
- **静态图片**：支持静态图片立绘
- **CG 模式**：检测到无动作/表情文件时自动切换

#### 立绘控制

- 大小调整：50%-150%
- 水平位置：0%-100%
- 垂直位置：0%-100%

---

### 6. 角色状态栏

点击左上角 👤 按钮打开角色状态栏面板：

#### 角色属性

- 时间、地点显示
- 数值属性网格（从 MVU 变量提取）
- 文本属性卡片（关系、心情、吐槽、待办）

#### 小剧场

- 气泡对话显示
- 左右分布（主视角/其他角色）
- 自动解析 `【发言人：内容】` 格式

#### 数据来源

1. 优先从 MVU 变量框架获取（`Mvu.getMvuData`）
2. 其次解析 `<StatusBlock>` 正则

---

### 7. 用户消息编辑

#### 功能

- **保存到正文**：📇 按钮将输入保存为 `[[user||...]]` 格式
- **编辑消息**：点击 user 消息可编辑
- **删除消息**：可删除 user 消息
- **内存暂存**：编辑操作先存内存，发送时应用

---

### 7. 流式加载

- **实时显示**：AI 生成时显示呼吸指示器
- **渐进加载**：对已完成文本应用打字机效果
- **状态管理**：正确处理流式/完成状态切换
- **不刷新界面**：所有编辑操作都不刷新界面，保持界面状态

---

### 8. 转场效果

#### 黑屏转场

- 全屏黑屏显示
- 转场文字居中
- 点击左半屏返回，点击右半屏继续
- 箭头指示交互区域

---

### 9. 播放控制

#### 自动播放

- 开关控制
- 速度调整：1-8秒/句
- 黑屏自动延长 2 秒

#### 手动控制

- 点击画面继续
- 箭头按钮导航
- 全屏模式支持（手机全屏后自动旋转 90 度显示横屏）

#### 重演功能

- 📖 按钮重新解析当前消息

---

## UI 布局

### 左上角

- 👤 角色按钮（点击展开菜单）
- ✏️ 输入按钮（折叠在角色按钮中）

### 右上角

- ⚙️ 设置按钮（点击展开菜单）
- 🔲 全屏按钮
- 📖 重演按钮

### 底部

- 对话框/选项框

---

## 响应式设计

### 横屏显示

- **比例**：16:9 横屏显示
- **适配方式**：使用 `width` 和 `aspect-ratio` 实现，符合 iframe 适配要求
- **背景透明**：界面外背景透明，不填充颜色

### 屏幕适配

- **横屏**：正常显示，等比例缩放
- **竖屏**：等比例缩放，保持横屏比例
- **全屏**：手机全屏后自动旋转 90 度显示横屏

---

## 技术实现

### 前端技术栈

- **Vue 3**：Composition API
- **Tailwind CSS**：样式系统
- **PixiJS + pixi-live2d-display**：Live2D 渲染
- **TypeScript**：类型安全

### 性能优化

- `shallowRef` 用于大型数组
- localStorage 缓存样式设置
- 事件监听器自动清理
- 共享工具函数减少代码重复

### 数据流

1. 从酒馆读取消息 → `parseMessageBlocks` 解析
2. 从角色卡变量读取 Live2D 配置
3. 监听酒馆事件实时更新
4. 用户交互 → 裁剪/发送消息 → 触发 AI

---

## 酒馆集成

### 使用的 API

- `getChatMessages()` - 获取聊天消息
- `createChatMessages()` - 创建消息
- `deleteChatMessages()` - 删除消息
- `setChatMessages()` - 更新消息
- `getCurrentMessageId()` - 获取当前消息 ID
- `getLastMessageId()` - 获取最后消息 ID
- `getVariables()` - 获取角色卡变量
- `triggerSlash('/trigger')` - 触发 AI 生成
- `eventOn()` - 监听酒馆事件

### 监听的事件

- `MESSAGE_RECEIVED` - 新消息到达
- `MESSAGE_UPDATED` - 消息更新
- `CHAT_CHANGED` - 聊天切换
- `STREAM_TOKEN_RECEIVED` - 流式 token

---

## 使用说明

### 基本使用

1. 在酒馆中打开角色卡
2. 开始对话，消息自动显示
3. 点击画面继续对话
4. 点击右上角齿轮打开设置

### Live2D 模型配置

1. 在角色卡变量中配置 `live2d_models` 数组
2. 每个模型需包含：id, name, modelPath, basePath, motions, expressions 等
3. 界面根据角色名自动匹配模型

### 样式自定义

1. 点击齿轮图标
2. 在"形状"标签页开启"自定义模式"
3. 调整样式预设和颜色
4. 点击"保存应用"

### 消息格式

AI 回复需要使用指定的 `[[type||...]]` 格式，界面会自动解析并渲染对应的演出效果。

---

## 配置示例

### Live2D 模型配置（角色卡变量）

```json
{
  "live2d_models": [
    {
      "id": "character_01",
      "name": "角色名",
      "modelPath": "model.model3.json",
      "basePath": "https://example.com/models/",
      "version": 3,
      "motions": [
        { "group": "idle", "name": "待机", "file": "idle.motion3.json" }
      ],
      "expressions": ["happy", "sad", "angry"],
      "textures": ["texture_00.png"]
    }
  ]
}
```

### 消息格式示例

```
[[character||小明||classroom.jpg||idle||happy||"你好，很高兴见到你！"]]
[[narration||classroom.jpg||教室里阳光明媚。]]
[[blacktext||三小时后...]]
[[choice||去食堂||去图书馆||回宿舍]]
```

---

## 测试模式

### 自动测试数据

当酒馆中没有消息时，界面会自动加载测试数据，方便演示和调试：

- 包含完整的对话流程示例
- 展示各种消息类型（角色对话、旁白、黑屏、选项）
- 展示 through 内心独白效果
- 展示场景切换

---

## Live2D 实现说明

### 动态加载方案

为了避免 pixi-live2d-display 与 pixi.js v8 的版本冲突，本项目采用**动态 CDN 加载**方案：

1. Live2D 依赖在运行时从 CDN 动态加载
2. 使用 pixi.js v6.5.10（与 pixi-live2d-display 兼容）
3. Cubism Core 自动从 CDN 加载
4. 不占用编译时打包体积

### 优势

- 无编译错误
- 按需加载，首屏更快
- Live2D 资源自动管理
- 完整的 Live2D 功能支持

---

## 注意事项

1. **消息格式**：AI 需要使用指定格式输出，否则将使用默认解析
2. **Live2D 模型**：需要先配置模型才能使用 Live2D 功能
3. **MVU 集成**：角色状态栏需要 MVU 变量框架支持
4. **样式保存**：样式自动保存到 localStorage，清除浏览器数据会重置
5. **事件清理**：组件卸载时自动清理事件监听器，避免内存泄漏
6. **测试模式**：无消息时自动显示测试数据，方便调试
7. **iframe 适配**：界面使用 `width` 和 `aspect-ratio` 实现响应式，符合 iframe 适配要求
